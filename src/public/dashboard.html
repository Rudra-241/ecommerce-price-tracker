<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    body {
      display: flex;
      height: 100vh;
      background: #f4f4f4;
    }
    .sidebar {
      width: 25%;
      background: #fff;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }
    .sidebar h2 {
      margin-bottom: 10px;
    }
    .product-item {
      display: flex;
      align-items: center;
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
      transition: 0.3s;
    }
    .product-item:hover {
      background: #f0f0f0;
    }
    .product-item img {
      width: 50px;
      height: 50px;
      margin-right: 10px;
    }
    .content {
      flex: 1;
      padding: 20px;
    }
    .form {
      margin-bottom: 20px;
      display: flex;
    }
    .form input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .form button {
      padding: 10px 15px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      margin-left: 10px;
      border-radius: 5px;
    }
    .form button:hover {
      background: #0056b3;
    }
    .price-history {
      margin-top: 20px;
    }
  </style>
</head>
<body>
<aside class="sidebar">
  <h2>Tracked Products</h2>
  <div id="product-list"></div>
</aside>
<main class="content">
  <div class="form">
    <input
            type="text"
            id="product-url"
            placeholder="Enter product URL"
    />
    <button onclick="addProduct()">Add URL</button>
  </div>
  <div id="product-details"></div>
  <canvas id="priceChart"></canvas>
</main>
<script>
  async function addProduct() {
    const url = document.getElementById("product-url").value;
    if (!url) return;
    await fetch("/api/product", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ "url":url }),
    });
    loadProducts();
  }

  async function loadProducts() {
    const response = await fetch("/api/products");
    const data = await response.json();
    const list = document.getElementById("product-list");
    list.innerHTML = "";
    data.tracked_products.forEach((p) => {
      const item = document.createElement("div");
      item.className = "product-item";
      item.innerHTML = `<img src="${p.ImgLink}" alt="${p.Name}"><span>${p.Name}</span>`;
      item.onclick = () => loadProductDetails(p.ID);
      list.appendChild(item);
    });
  }

  async function loadProductDetails(id) {
    const response = await fetch(`/api/product/${id}`, {
      method: "GET",
    });
    const data = await response.json();
    const details = document.getElementById("product-details");
    details.innerHTML = `<h2>${data.product_name}</h2><p>Current Price: ₹${data.current_price}</p>`;

    renderChart(data.price_history);
  }

  let priceChart = null; // Store chart instance globally

  function renderChart(history) {
    const ctx = document.getElementById("priceChart").getContext("2d");

    // Destroy previous chart instance if it exists
    if (priceChart) {
      priceChart.destroy();
    }

    // Create new chart instance and store it
    priceChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: history.map((h) => new Date(h.ChangedAt).toLocaleDateString()),
        datasets: [
          {
            label: "Price",
            data: history.map((h) => h.Price),
            borderColor: "#007bff",
            backgroundColor: "rgba(0, 123, 255, 0.1)",
            fill: true,
            tension: 0.4, // Smooth curve
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: "top",
          },
        },
        scales: {
          x: {
            title: { display: true, text: "Date" },
          },
          y: {
            title: { display: true, text: "Price (₹)" },
          },
        },
      },
    });
  }


  loadProducts();
</script>
</body>
</html>
